name: Upload GPU Module Binaries

on:
  workflow_dispatch:
  release:
    types: [created]

# Note: This workflow uploads pre-built binaries only.
# Source files (engine.py, kernels.py) are not in the repository.
# Build binaries locally using scripts/build_modules.bat (Windows)
# or scripts/build_modules.sh (Linux/macOS) before running this workflow.

jobs:
  upload-binaries:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            extension: pyd
          - os: ubuntu-latest
            platform: linux
            extension: so
          - os: macos-latest
            platform: macos
            extension: so
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Verify binaries exist
      run: |
        python -c "import os; path='gpu_core/bin/${{ matrix.platform }}'; files=[f for f in os.listdir(path) if f.endswith('.${{ matrix.extension }}')]; print(f'Found {len(files)} binary files: {files}'); assert len(files) >= 2, f'Expected at least 2 .${{ matrix.extension }} files in {path}, found {len(files)}'"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gpu-modules-${{ matrix.platform }}
        path: gpu_core/bin/${{ matrix.platform }}/*.${{ matrix.extension }}
        retention-days: 90
